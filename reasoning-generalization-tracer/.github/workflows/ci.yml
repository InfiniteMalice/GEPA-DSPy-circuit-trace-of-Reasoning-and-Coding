name: CI

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install pytest
        working-directory: reasoning-generalization-tracer
      - name: Lint
        run: python -m compileall src
        working-directory: reasoning-generalization-tracer
      - name: Unit tests
        run: pytest -q
        working-directory: reasoning-generalization-tracer
      - name: Smoke self-play
        run: |
          OUTPUT=$(rg-tracer self-play --profile proof_math --k 3 \
            --problem datasets/toy_math/addition_small.jsonl \
            --concept parity --sampler trm)
          echo "Self-play output: $OUTPUT"
          RUN_DIR=$(python -c 'import json,sys; print(json.loads(sys.argv[1])["run_dir"])' "$OUTPUT")
          test -f "$RUN_DIR/summary.md"
          test -f "$RUN_DIR/semantics.jsonl"
          test -f "$RUN_DIR/attr_metrics.jsonl"
          test -d "$RUN_DIR/attr"
          ls "$RUN_DIR/attr"
          grep -q "Attribution Metrics" "$RUN_DIR/summary.md"
        working-directory: reasoning-generalization-tracer
      - name: Concept reward smoke
        run: |
          python - <<'PY'
          from rg_tracer.concepts import ConceptSpec, compute_concept_reward

          trace = {
              "features": [
                  {"id": "F1", "layer": 1, "importance": 0.7, "tags": ["parity"]}
              ],
              "edges": [],
              "path_lengths": {"mean": 1.0},
          }
          spec = ConceptSpec(name="parity", definition="", expected_substructures=["parity"])
          reward = compute_concept_reward(
              trace,
              spec,
              task_metrics={
                  "concept_reuse": 1.0,
                  "supporting_tasks": 1,
                  "entailed_feature_ids": ["F1"],
              },
          )
          assert reward > 0.3, reward
          PY
        working-directory: reasoning-generalization-tracer
      - name: Smoke humanities CLI
        run: |
          rg-tracer humanities --dataset datasets/humanities/sample_claims.jsonl \
            --profile humanities > humanities.json
          test -s humanities.json
          python - <<'PY'
          import json
          data = json.load(open("humanities.json", "r", encoding="utf8"))
          assert data["records"], data
          assert any(record["abstained"] for record in data["records"])
          PY
        working-directory: reasoning-generalization-tracer
      - name: Smoke fallback pipeline
        run: |
          python - <<'PY'
          from rg_tracer.fallback import run_academic_pipeline

          output = run_academic_pipeline("datasets/humanities/sample_claims.jsonl")
          assert output["summary"]["count"] >= 2
          assert any(not rec["abstained"] for rec in output["records"])
          assert any(rec["abstained"] for rec in output["records"])
          for record in output["records"]:
              if not record["abstained"]:
                  assert "posterior" in record
          PY
        working-directory: reasoning-generalization-tracer
      - name: Upload runs artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: runs
          path: reasoning-generalization-tracer/runs
          if-no-files-found: ignore
