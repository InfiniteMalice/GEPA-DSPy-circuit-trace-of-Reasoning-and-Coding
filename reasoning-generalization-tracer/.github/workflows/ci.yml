name: CI

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install pytest
        working-directory: reasoning-generalization-tracer
      - name: Lint
        run: python -m compileall src
        working-directory: reasoning-generalization-tracer
      - name: Unit tests
        run: pytest -q
        working-directory: reasoning-generalization-tracer
      - name: Smoke self-play
        run: |
          set -euo pipefail
          RUN_DIR=$(rg-tracer self-play --profile proof_math --k 3 \
            --problem datasets/toy_math/addition_small.jsonl \
            --concept parity --sampler trm \
            | python .github/scripts/extract_run_dir.py) || {
              echo "Failed to extract run_dir from rg-tracer output" >&2
              exit 1
            }
          export RUN_DIR
          test -f "$RUN_DIR/summary.md"
          test -f "$RUN_DIR/semantics.jsonl"
          test -f "$RUN_DIR/attr_metrics.jsonl"
          test -d "$RUN_DIR/attr"
          python .github/scripts/validate_metrics.py
        working-directory: reasoning-generalization-tracer
      - name: Concept reward smoke
        run: python .github/scripts/concept_smoke.py
        working-directory: reasoning-generalization-tracer
      - name: Smoke humanities CLI
        run: |
          rg-tracer humanities --dataset datasets/humanities/sample_claims.jsonl \
            --profile humanities > humanities.json
          test -s humanities.json
          python - <<'PY'
          import json

          data = json.load(open("humanities.json", "r", encoding="utf8"))
          assert data["records"], data
          assert any(record["abstained"] for record in data["records"])
          PY
        working-directory: reasoning-generalization-tracer
      - name: Smoke fallback pipeline
        run: |
          python - <<'PY'
from rg_tracer.fallback import run_academic_pipeline

          output = run_academic_pipeline(
              "datasets/humanities/sample_claims.jsonl"
          )
          assert output["summary"]["count"] >= 2
          assert any(not rec["abstained"] for rec in output["records"])
          assert any(rec["abstained"] for rec in output["records"])
          for record in output["records"]:
              if not record["abstained"]:
                  assert "posterior" in record
          PY
        working-directory: reasoning-generalization-tracer
      - name: Upload runs artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: runs
          path: reasoning-generalization-tracer/runs
          if-no-files-found: ignore
