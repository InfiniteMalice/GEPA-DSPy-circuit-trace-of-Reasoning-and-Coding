name: CI

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install pytest
        working-directory: reasoning-generalization-tracer
      - name: Lint
        run: python -m compileall src
        working-directory: reasoning-generalization-tracer
      - name: Unit tests
        run: pytest -q
        working-directory: reasoning-generalization-tracer
      - name: Smoke self-play
        run: |
          set -euo pipefail
          RUN_DIR=$(rg-tracer self-play --profile proof_math --k 3 \
            --problem datasets/toy_math/addition_small.jsonl \
            --concept parity --sampler trm \
            | python - <<'PY'
          import json
          import sys

          try:
              data = json.load(sys.stdin)
          except json.JSONDecodeError as exc:  # pragma: no cover - CI guard
              raise SystemExit(f"Failed to parse rg-tracer output: {exc}") from exc
          if "run_dir" not in data:
              raise SystemExit(f"Missing run_dir in output: {data}")
          print(data["run_dir"])
PY
          ) || { echo "Failed to extract run_dir from rg-tracer output"; exit 1; }
          export RUN_DIR
          test -f "$RUN_DIR/summary.md"
          test -f "$RUN_DIR/semantics.jsonl"
          test -f "$RUN_DIR/attr_metrics.jsonl"
          test -d "$RUN_DIR/attr"
          ls "$RUN_DIR/attr"
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          run_dir = Path(os.environ["RUN_DIR"])
          metrics_path = run_dir / "attr_metrics.jsonl"
          lines = [
              json.loads(line)
              for line in metrics_path.read_text(encoding="utf8").splitlines()
              if line.strip()
          ]
          assert lines, "attr_metrics.jsonl is empty"
          for key in (
              "delta_alignment",
              "delta_repeatability",
              "delta_sparsity",
          ):
              assert key in lines[0], lines[0]
          attr_dir = run_dir / "attr"
          files = list(attr_dir.iterdir())
          assert files, "attr directory empty"
          assert any(path.suffix == ".json" for path in files), files
          PY
          grep -q "Attribution Metrics" "$RUN_DIR/summary.md"
        working-directory: reasoning-generalization-tracer
      - name: Concept reward smoke
        run: |
          python - <<'PY'
from rg_tracer.concepts import ConceptSpec, compute_concept_reward

          trace = {
              "features": [
                  {"id": "F1", "layer": 1, "importance": 0.7, "tags": ["parity"]}
              ],
              "edges": [],
              "path_lengths": {"mean": 1.0},
          }
          spec = ConceptSpec(
              name="parity",
              definition="",
              expected_substructures=["parity"],
          )
          reward = compute_concept_reward(
              trace,
              spec,
              task_metrics={
                  "concept_reuse": 1.0,
                  "supporting_tasks": 1,
                  "entailed_feature_ids": ["F1"],
              },
          )
          assert reward > 0.3, reward
          aligned = compute_concept_reward(
              trace,
              spec,
              task_metrics={
                  "concept_reuse": 1.0,
                  "supporting_tasks": 1,
                  "entailed_feature_ids": ["F1"],
              },
              alignment=0.5,
          )
          assert aligned > reward
          PY
        working-directory: reasoning-generalization-tracer
      - name: Smoke humanities CLI
        run: |
          rg-tracer humanities --dataset datasets/humanities/sample_claims.jsonl \
            --profile humanities > humanities.json
          test -s humanities.json
          python - <<'PY'
          import json

          data = json.load(open("humanities.json", "r", encoding="utf8"))
          assert data["records"], data
          assert any(record["abstained"] for record in data["records"])
          PY
        working-directory: reasoning-generalization-tracer
      - name: Smoke fallback pipeline
        run: |
          python - <<'PY'
from rg_tracer.fallback import run_academic_pipeline

          output = run_academic_pipeline(
              "datasets/humanities/sample_claims.jsonl"
          )
          assert output["summary"]["count"] >= 2
          assert any(not rec["abstained"] for rec in output["records"])
          assert any(rec["abstained"] for rec in output["records"])
          for record in output["records"]:
              if not record["abstained"]:
                  assert "posterior" in record
          PY
        working-directory: reasoning-generalization-tracer
      - name: Upload runs artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: runs
          path: reasoning-generalization-tracer/runs
          if-no-files-found: ignore
